<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Claims Management System</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"> <!-- tailwind css -->
        <script src="https://unpkg.com/htmx.org@1.9.10"></script> <!-- htmx -->
        <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script> <!-- alpine.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>   <!-- chart.js -->

    </head>

    <body class="bg-gray-50 p-6">

        <h1 class="text-2xl text-center font-bold mb-4">Claims Management System</h1> <!-- table title -->
        <!-- flex container to display welcome message and logout button horizontally -->
        {% if user.is_authenticated %}
        <div class="flex items-center gap-2 mb-4">
                <span class="font-semibold">Welcome, {{ user.get_full_name }} |</span>          <!-- user template allows for get_full_name pulls first_name and last_name --> 
                <!-- post method for logout button -->
                <form method="post" action="{% url 'logout' %}" class="m-0 p-0">
                    {% csrf_token %}
                    <button type="submit" class="text-blue-600 bg-transparent p-0 border-0 cursor-pointer">
                        Logout
                    </button>
                </form>
            </div>
        <!-- displays login button if page is somehow accessed without log in-->
        {% else %}
            <a href="{% url 'login' %}">Login</a>
        {% endif %}


        <!-- x-data initializes an alpine reactive state variable named open set to false, tracking whether filter dropdown is open or not.
            Clicking outside of the panel (form) sets the variable back to false to close it -->
        <form
            hx-get="{% url 'home' %}"
            hx-target="#claims-table"
            hx-swap="innerHTML"
            class="mb-4"
            x-data="{ open: false }"
            @click.outside="open = false"
            >
            <div class="flex items-center space-x-2">
                <div class="relative flex-grow">
                    <!-- Search icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>

                    <!-- Input -->
                    <input
                        type="search"
                        name="q"
                        id="search"
                        placeholder="Search claims..."
                        value="{{ q }}"
                        class="w-full pl-10 pr-4 py-2 border rounded"
                        autocomplete="off"
                    />
                </div>


                <!-- @click is used here to open and close the dropdown when clicking the filter button -->
                <button
                    type="button"
                    @click="open = !open"
                    class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 flex items-center gap-2"> <!-- items-center gap-2 to align icon and text -->
                
                    <!-- filter svg icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z" />
                    </svg>

                    Filter
                </button>

                
            </div>

            <!-- shows the pannel only when open is true, x-transition adds visual effect-->
            <div
                x-show="open"
                class="mt-2 p-4 border rounded bg-white shadow-md"
                x-transition>

                <label class="block mb-2">
                Insurer:
                <select name="insurer" class="mt-1 px-3 py-2 border rounded w-full">
                    <option value="">All Insurers</option>
                    {% for insurer in insurers %}
                    <option value="{{ insurer }}" {% if insurer == selected_insurer %}selected{% endif %}>
                        {{ insurer }}
                    </option>
                    {% endfor %}
                </select>
                </label>

                <!-- selected attribute is added to keep the user selection in the filter dropdown even after page updates for both insurer and staturs-->

                <label class="block mb-6">
                Status:
                <select name="status" class="mt-1 px-3 py-2 border rounded w-full">
                    <option value="">All Statuses</option>
                    {% for status in statuses %}
                    <option value="{{ status }}" {% if status == selected_status %}selected{% endif %}>
                        {{ status }}
                    </option>
                    {% endfor %}
                </select>
                </label>

                <button
                type="submit"
                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Apply
                </button>

            </div>
        </form>



        <!-- HTMX table setup, loads frome home url, on fetch load the table target is claims-table to swap the inner html --> 
        <div    id="claims-table" 
                hx-get="{% url 'home' %}"   
                hx-trigger="load"  
                hx-target="#claims-table" 
                hx-swap="innerHTML">

                <!-- claims table and pagination controls -->
                {% include "claims/claims_table_body.html" %}
        </div>
        

        <!-- admin panel section, will be empty until triggered by button in actions_partial -->
        <div    id="admin-panel"
                hx-target="#admin-panel"
                hx-swap="innerHTML">
        
        </div>

    </body>

    <script>
        
        var lastEditClaimId = null;         //initializes emptyy
        var editHitCount = 0;               //initialized at zero

        //listens for edit url to be called to start a counter to only update claims-table upon second edit url call per claim, first to load form, second to submit form and update table 
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            const urlMatch = evt.detail.xhr?.responseURL.match(/\/claim\/(\d+)\/edit\/$/);          
            if (urlMatch) {                                              //checks if the edit url is called
                const claimId = urlMatch[1];                             //extracts claim id 

                if (claimId === lastEditClaimId) {                      //this will cause editHitCount to be 2 due to it being from same id,
                    editHitCount += 1;
                } else {
                    lastEditClaimId = claimId;                          //edithitcount will be 1 for selected claim
                    editHitCount = 1;
                }

                if (editHitCount === 2) {
                    //Read current table state from hidden inputs
                    const page = document.getElementById('current-page')?.value || 1;
                    const q = document.getElementById('current-q')?.value || '';
                    const insurer = document.getElementById('current-insurer')?.value || '';
                    const status = document.getElementById('current-status')?.value || '';

                    //Update claims table with current filter parameters and page number
                    htmx.ajax('GET', `/?page=${page}&q=${encodeURIComponent(q)}&insurer=${encodeURIComponent(insurer)}&status=${encodeURIComponent(status)}`, {target: '#claims-table', swap: 'innerHTML'});

                    //Resets counter and claim cache
                    editHitCount = 0;
                    lastEditClaimId = null;
                }
            }
        });

    </script>
</html>
